<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7fc;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 20px 0;
            text-align: center;
        }

        .admin-only {
            display: none; /* Скрываем элементы по умолчанию */
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
<header>
    <h1>User Management</h1>
</header>

<div id="user-info">
    <p>Loading user data...</p>
</div>

<button onclick="logout()">Logout</button>

<!-- Панель администратора -->
<div id="admin-panel" class="admin-only">
    <h2>Admin Panel</h2>
    <p>Welcome, administrator! Here are your options:</p>
    <ul>
        <li><a href="/admin/dashboard">Dashboard</a></li>
        <li><a href="/admin/users">Manage Users</a></li>
    </ul>
</div>
<a href="/payment">Перейти к оплате</a>
<!-- Email Broadcast Form -->
<div class="form admin-only">
    <h2>Send Broadcast Email</h2>
    <label for="email-to">Recipient</label>
    <input type="text" id="email-to" placeholder="Enter recipient email or 'all' for broadcast">
    <input type="text" id="email-subject" placeholder="Enter email subject">
    <textarea id="email-body" placeholder="Enter your message"></textarea>
    <label for="email-file">Attachment</label>
    <input type="file" id="email-file">
    <button onclick="sendBroadcastEmail()">Send Email</button>
</div>

<!-- Create User Form -->
<div class="form admin-only">
    <h2>Create User</h2>
    <input type="text" id="create-name" placeholder="Enter name">
    <input type="email" id="create-email" placeholder="Enter email">
    <button onclick="createUser()">Create</button>
</div>

<!-- Update User Form -->
<div class="form admin-only">
    <h2>Update User</h2>
    <input type="text" id="update-id" placeholder="Enter user ID">
    <input type="text" id="update-name" placeholder="Enter new name">
    <input type="email" id="update-email" placeholder="Enter new email">
    <button onclick="updateUser()">Update</button>
</div>

<!-- Get User by ID -->
<div class="form admin-only">
    <h2>Get User by ID</h2>
    <input type="text" id="get-id" placeholder="Enter user ID">
    <button onclick="getUserById()">Get User</button>
    <div id="user-details"></div>
</div>

<!-- Filter, Sort, and Pagination -->
<div class="form admin-only">
    <h2>Search and Sort Users</h2>
    <input type="text" id="filter-name" placeholder="Enter name">
    <select id="sort-field">
        <option value="name">Name</option>
        <option value="email">Email</option>
    </select>
    <select id="sort-order">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
</div>

<!-- User List -->
<h2>All Users</h2>
<table class="admin-only">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="user-list"></tbody>
</table>

<!-- Pagination -->
<div class="pagination admin-only">
    <button id="prev-page" onclick="prevPage()" disabled>Previous</button>
    <span id="current-page">1</span>
    <button id="next-page" onclick="nextPage()">Next</button>
</div>

<script>
    async function checkAuth() {
        const token = localStorage.getItem('authToken');
        const role = localStorage.getItem('userRole');

        if (!token) {
            alert('You are not logged in. Redirecting to login page.');
            window.location.href = "/login";
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/profile', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('user-info').innerHTML = `
                    <h2>Hello, ${result.data.name}</h2>
                    <p>Email: ${result.data.email}</p>
                    <p>Role: ${role === '1' ? 'Admin' : 'User'}</p>
                `;

                // Проверка роли: если админ, показываем admin-only блоки
                if (role === '1') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                } else {
                    // Для обычного пользователя скрываем административные блоки
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                }
            } else {
                alert('Session expired. Redirecting to login page.');
                localStorage.removeItem('authToken');
                window.location.href = "/login";
            }
        } catch (err) {
            console.error('Error loading profile:', err);
            alert('Failed to load profile. Please log in again.');
            localStorage.removeItem('authToken');
            window.location.href = "/login";
        }
    }

    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userRole');
        window.location.href = "/login";
    }

    async function createUser() {
        const role = localStorage.getItem('userRole');
        if (role !== '1') {
            alert('Access denied! Only admins can create users.');
            return;
        }

        const name = document.getElementById('create-name').value;
        const email = document.getElementById('create-email').value;

        try {
            const response = await fetch('/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ name, email })
            });

            if (!response.ok) throw new Error('Failed to create user.');

            alert('User created successfully!');
        } catch (error) {
            console.error('Create user error:', error);
            alert(error.message);
        }
    }

    async function getUserById() {
        const id = document.getElementById('get-id').value;

        try {
            const response = await fetch(`/users/${id}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!response.ok) throw new Error('Failed to get user.');

            const data = await response.json();
            const user = data.data;

            document.getElementById('user-details').innerHTML = `
                <p><strong>ID:</strong> ${user.id}</p>
                <p><strong>Name:</strong> ${user.name}</p>
                <p><strong>Email:</strong> ${user.email}</p>
            `;
        } catch (error) {
            console.error('Get user error:', error);
            alert(error.message);
        }
    }

    async function sendBroadcastEmail() {
        const to = document.getElementById('email-to').value;
        const subject = document.getElementById('email-subject').value;
        const body = document.getElementById('email-body').value;

        if (!to || !subject || !body) {
            alert('Please fill in all fields.');
            return;
        }

        try {
            const response = await fetch('/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ to, subject, body })
            });

            if (!response.ok) throw new Error('Failed to send email.');
            alert('Email sent successfully!');
        } catch (error) {
            console.error('Email send error:', error);
            alert(error.message);
        }
    }

    async function updateUser() {
        const id = document.getElementById('update-id').value;
        const name = document.getElementById('update-name').value;
        const email = document.getElementById('update-email').value;

        try {
            const response = await fetch(`/users/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ name, email })
            });

            if (!response.ok) throw new Error('Failed to update user.');

            alert('User updated successfully!');
        } catch (error) {
            console.error('Update user error:', error);
            alert(error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', checkAuth);
</script>

</body>
</html>
